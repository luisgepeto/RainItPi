@{
    ViewBag.Title = "Add Routine";
}
@using Newtonsoft.Json
@model RainIt.Domain.DTO.RoutineDTO
<style>
    .delete-button {
        width: 30px;
        height: 30px;
        background: url('../../../../Content/icons/delete.png') no-repeat center center;
        background-size: contain;
        position: absolute;
        left: 92%;
        top: -15px;
        z-index: 2;
    }
    .ss-cloned-child {
        border: 5px solid red;
    }
</style>
<div class="container">
    <div id="routine-builder" class="row shapeshift-gallery">
        <div class="shapeshift-element">
            <div id="img-add" class="limit-view img-holder img-adder img-thumbnail">
                <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/>
            </div>
        </div>
    </div>
    <div class=" row">
        <div class="col-md-2">
            @if (Model == null || Model.RoutineId == 0)
            {
                <input type="button" value="Add" name="Add" id="addRoutine" class="btn btn-success"/>
            }
            else
            {
                <input type="button" value="Update" name="Update" id="addRoutine" class="btn btn-success"/>
            }
            
        </div>
        <div class="col-md-3">
            @Html.Action("Multiselect", "Device", new { area = "Configuration" })
        </div>
    </div>
</div>
@Html.Action("Index", "Pattern", new {area ="Configuration"})

<script type="text/javascript">
    (function () {
        this.RoutineAddProperties = this.RoutineAddProperties || {};
        var passedImages = '@Html.Raw(Model != null ? JsonConvert.SerializeObject(Model.RoutinePatternDTOs) : null)';

        var deleteButton = (function () {
            var properties = {};
            
            properties.AddClickListenerTo = function (button) {
                if (button == undefined)
                    button = $('#routine-builder .delete-button');
                return button.click(function (e) {
                    $(e.currentTarget).closest('.shapeshift-element').detach();
                    $('#routine-builder').trigger('ss-rearrange');
                    $("#routine-builder").trigger("ss-added");
                });
            }

            function addButtonTo(element) {
                var deleteButton = $('<div>').attr("class", "delete-button pointer");
                properties.AddClickListenerTo(deleteButton);
                deleteButton.appendTo(element.find('.img-holder'));
            }

            properties.Initialize = function (element) {
                addButtonTo(element);
            }
            return properties;
        }());

        var routineBuilder = (function () {
            var properties = {};
            function createImage(image) {
                var imageToPlace = $('<img>').attr("src", image.PatternDTO.Path).attr("class", "img-element move").attr("data-orig-src", image.PatternDTO.Path).attr("data-pattern-id", image.PatternDTO.PatternId);
                var column = $('<div>').attr("class", "shapeshift-element");
                var imageHolder = $('<div>').attr("class", "limit-view img-holder img-thumbnail move");
                var deleteButton = $('<div>').attr("class", "delete-button pointer");
                deleteButton.appendTo(imageHolder);
                imageToPlace.appendTo(imageHolder);
                var caption = $('<div>').addClass("caption img-title").html("<p>" + image.PatternDTO.Name + "</p>").css("display", "none");
                imageHolder.appendTo(column);
                caption.appendTo(column);
                return column;
            }

            function initializeUserImages(passedImages) {
                $.each(passedImages, function (index, imageData) {
                    var imageAdder = $('#routine-builder .img-adder').parent();
                    var image = createImage(imageData);
                    image.insertBefore(imageAdder);
                });
            }

            function revertHoverStatus(originalElement, clonedElement) {
                clonedElement.find('.img-element').attr('src', originalElement.find('.img-element').attr('data-orig-src'));
                clonedElement.find('.k-loading-mask').hide();
                clonedElement.find('.img-title').hide();
            }

            function hasElements() {
                var allElements = $('#routine-builder .shapeshift-element').children('.img-holder').not('.img-adder').parent();
                return allElements.length > 0;
            }
            function hideImageAdder() {
                $('#routine-builder .img-adder').closest('.shapeshift-element').hide();
            }
            function showImageAdder() {
                $('#routine-builder .img-adder').closest('.shapeshift-element').show();
            }
            function addAddEventListener() {
                $('#routine-builder').on('ss-added', function (e, element) {
                    hasElements() ? hideImageAdder() : showImageAdder();
                    if (element) {
                        var originalShapeshift = $(element);
                        var clonedShapeshift = $('.shapeshift-element').find('.img-element[data-pattern-id="' + originalShapeshift.find('.img-element').attr('data-pattern-id') + '"]').closest(".shapeshift-element").not('.img-copy');
                        revertHoverStatus(originalShapeshift, clonedShapeshift);
                        deleteButton.Initialize(originalShapeshift);
                        PatternIndexProperties.Gallery.ReattachHoverListeners();
                    }
                    $('#routine-builder').trigger('ss-rearrange');
                });
            }
            properties.Initialize = function () {
                if (passedImages != '') {
                    initializeUserImages(JSON.parse(passedImages));
                }
                $('#routine-builder').shapeshift({
                    enableDrag: true,
                    enableCrossDrop: true,
                    selector: '.shapeshift-element',
                    gutterY: 30,
                    gutterX: 30
                });
                addAddEventListener();
                deleteButton.AddClickListenerTo();
                image.Initialize();
                $("#routine-builder").trigger("ss-added");
            }
            return properties;
        }());

        var image = (function () {
            var properties = {};
            var hasAjaxRunFor = [];
            
            function makeHoverAjaxCall(currentImageHolder) {
                var id = currentImageHolder.find('.img-element').attr("data-pattern-id");
                if (hasAjaxRunFor.indexOf(id) == -1) {
                    hasAjaxRunFor.push(id);
                    currentImageHolder.setAjaxLoadingAnimation();
                    var url = '@Url.Action("GetBlackWhiteFor", "Pattern", new { area = "Configuration", patternId = -1})';
                    url = url.replace("-1", id);
                    $.ajax({
                        url: url,
                        type: "GET",
                        contentType: "application/x-www-form-urlencoded",
                        success: function (data) {
                            var allImageHolders = $('.img-holder').find('.img-element[data-pattern-id="' + currentImageHolder.find('.img-element').attr('data-pattern-id') + '"]').closest('.img-holder');
                            allImageHolders.removeAjaxLoadingAnimation();
                            allImageHolders.children('.img-element').attr("data-bw-src", "data:image/png;base64," + data.blackWhiteFile);
                            if (currentImageHolder.is(":hover")) {
                                currentImageHolder.children('.img-element').attr("src", currentImageHolder.children('.img-element').attr("data-bw-src"));
                            }
                        }
                    });
                }
            }

            function hoverFunction(currentImageElement, mouseChangeFunction) {
                var originalSource = currentImageElement.attr("data-orig-src");
                var bwSource = currentImageElement.attr("data-bw-src");
                if (originalSource && bwSource) {
                    mouseChangeFunction(currentImageElement);
                }
            }
            function addHoverListener() {
                $('#routine-builder .img-holder:not(.img-adder)').hover(function (e) {
                    var currentImageHolder = $(e.currentTarget);
                    currentImageHolder.children('.k-loading-mask').show();
                    if (currentImageHolder.children('.img-element').attr("data-bw-src") == undefined) {
                        makeHoverAjaxCall(currentImageHolder);
                    }
                    currentImageHolder.siblings('.img-title').show();
                },
                function (e) {
                    var currentImageHolder = $(e.currentTarget);
                    currentImageHolder.children('.k-loading-mask').hide();
                    currentImageHolder.siblings('.img-title').hide();
                });

                $('#routine-builder .img-element').hover(function (e) {
                    var currentImageElement = $(e.currentTarget);
                    hoverFunction(currentImageElement, function (currentImageElement) {
                        currentImageElement.attr("src", currentImageElement.attr("data-bw-src"));
                    });
                }, function (e) {
                    var currentImageElement = $(e.currentTarget);
                    hoverFunction(currentImageElement, function (currentImageElement) {
                        currentImageElement.attr("src", currentImageElement.attr("data-orig-src"));
                    });
                });
            }
            properties.Initialize = function () {
                addHoverListener();
            }
            return properties;
        }());

        var galleryExtender = (function () {
            var properties = {};
            var oldParameters = PatternIndexProperties.Gallery.Parameters;
            var newParameters = {
                enableDrag: true,
                dragClone: true,
                cloneClass: "img-copy"
            }

            properties.Initialize = function () {
                $.extend(oldParameters, newParameters);
                PatternIndexProperties.Gallery.Update(oldParameters);
                PatternIndexProperties.Gallery.DeleteImageAdder();
                PatternIndexProperties.Gallery.DeleteImageDeleter();
                PatternIndexProperties.Gallery.RemovePatternClickListener();
                PatternIndexProperties.Gallery.ChangeHoverCursor();
            }
            return properties;
        }());


        var multiselectExtender = (function () {
            var properties = {};
            var devices = '@Html.Raw(Model != null ? JsonConvert.SerializeObject(Model.DeviceDTOs) : null)';
            function getAssignedDeviceGuids(allDevices) {
                var selectedDeviceGuids = [];
                $.each(allDevices, function (index, deviceData) {
                    selectedDeviceGuids.push(deviceData.Identifier);
                });
                return selectedDeviceGuids;
            }
            properties.Initialize = function () {
                if (devices != "") {
                    var selectedDeviceGuids = getAssignedDeviceGuids(JSON.parse(devices));
                    DeviceMultiselectProperties.SelectDevices(selectedDeviceGuids);
                }
            }
            properties.GetSelectedDevices = function () {
                return DeviceMultiselectProperties.GetSelectedDevices();
            }
            return properties;
        }());

        var addRoutine = (function () {
            var properties = {};

            function getPatternIdList() {
                var patternIdArrayList = [];
                $('#routine-builder').find('.img-holder').each(function () {
                    var currentImageHolder = $(this);
                    patternIdArrayList.push(currentImageHolder.find(".img-element").attr("data-pattern-id"));
                });
                return patternIdArrayList;
            }

            function onAjaxSuccess(data) {
                window.location.href = data;
            }

            function makeAddPatternAjaxCall(patternIdList, deviceGuidList) {
                $.ajax({
                    url: '@Url.Action("Add", "Routine", new {area = "Configuration"})',
                    data: {
                        routineId: '@Html.Raw(Model != null ? Model.RoutineId : 0)',
                        patternIdList: patternIdList,
                        deviceGuidList: deviceGuidList
                    },
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    success: onAjaxSuccess
                });
            }

            properties.AddClickListener = function () {
                $('#addRoutine').click(function () {
                    var patternIdList = getPatternIdList();
                    var deviceGuidList = multiselectExtender.GetSelectedDevices();
                    makeAddPatternAjaxCall(patternIdList, deviceGuidList);
                });
            }
            return properties;
        }());


        RoutineAddProperties.SetupPage = function () {
            routineBuilder.Initialize();
            galleryExtender.Initialize();
            addRoutine.AddClickListener();
            multiselectExtender.Initialize();
        }
    }());
    $(document).ready(function () {
        RoutineAddProperties.SetupPage();
    });
</script>