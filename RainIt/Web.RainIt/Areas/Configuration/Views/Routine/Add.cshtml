@{
    ViewBag.Title = "Add Routine";
}
@using Newtonsoft.Json
@model RainIt.Domain.DTO.RoutineDTO
<style>
    .delete-button {
        width: 30px;
        height: 30px;
        background: url('../../../../Content/icons/delete.png') no-repeat center center;
        background-size: contain;
        position: absolute;
        left: 92%;
        top: -15px;
        z-index: 2;
    }
    .ss-cloned-child {
        border: 5px solid red;
    }
</style>
<div class="container">
    <div id="routine-builder" class="row shapeshift-gallery">
        <div class="shapeshift-element">
            <div id="img-add" class="limit-view img-holder img-adder img-thumbnail pointer">
                <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"/>
            </div>
        </div>
    </div>
    <div class=" row">
        <div class="col-md-2">
            @if (Model == null || Model.RoutineId == 0)
            {
                <input type="button" value="Add" name="Add" id="addRoutine" class="btn btn-success"/>
            }
            else
            {
                <input type="button" value="Update" name="Update" id="addRoutine" class="btn btn-success"/>
            }
            
        </div>
        <div class="col-md-3">
            @Html.Action("Multiselect", "Device", new { area = "Configuration" })
        </div>
    </div>
</div>
@Html.Action("Index", "Pattern", new {area ="Configuration"})

<script type="text/javascript">
    (function () {
        this.RoutineAddProperties = this.RoutineAddProperties || {};
        var passedImages = '@Html.Raw(Model != null ? JsonConvert.SerializeObject(Model.RoutinePatternDTOs) : null)';

        var deleteButton = (function () {
            var properties = {};
            
            function addClickListenerTo(button) {
                return button.click(function (e) {
                    $(e.currentTarget).closest('.shapeshift-element').detach();
                    $('#routine-builder').trigger('ss-rearrange');
                });
            }

            function addButtonTo(element) {
                var deleteButton = $('<div>').attr("class", "delete-button pointer");
                addClickListenerTo(deleteButton);
                deleteButton.appendTo(element.find('.img-holder'));
            }

            properties.Initialize = function (element) {
                addButtonTo(element);
            }
            return properties;
        }());

        var routineBuilder = (function () {
            var properties = {};
            function createImage(image) {
                var imageToPlace = $('<img>').attr("id", "image" + image.PatternDTO.PatternId).attr("src", image.PatternDTO.Path);
                var imageHolder = $('<div>').attr("class", "image-holder").attr("id", "image-holder_" + image.PatternDTO.PatternId);
                var deleteButton = $('<div>').attr("class", "delete-button").attr("id", "delete_" + image.PatternDTO.PatternId);
                deleteButton.appendTo(imageHolder);
                imageToPlace.appendTo(imageHolder);
                return imageHolder;
            }
            function initializeUserImages(passedImagesArray) {
                $.each(passedImagesArray, function (index, imageData) {
                    var imageAdder = $('#addImage2');
                    var image = createImage(imageData);
                    image.insertBefore(imageAdder);
                });
            }
            function revertHoverStatus(originalElement, clonedElement) {
                clonedElement.find('.img-element').attr('src', originalElement.find('.img-element').attr('data-orig-src'));
                clonedElement.find('.k-loading-mask').hide();
                clonedElement.find('.img-title').hide();
            }
            

            function addAddEventListener() {
                $('#routine-builder').on('ss-added', function (e, element) {
                    var originalShapeshift = $(element);
                    var clonedShapeshift = $('.shapeshift-element').find('.img-element[data-pattern-id="' + originalShapeshift.find('.img-element').attr('data-pattern-id') + '"]').closest(".shapeshift-element").not('.img-copy');
                    revertHoverStatus(originalShapeshift, clonedShapeshift);
                    deleteButton.Initialize(originalShapeshift);
                    $('#routine-builder').trigger('ss-rearrange');
                    PatternIndexProperties.Gallery.ReattachHoverListeners();

                });
            }
            properties.Initialize = function () {
                if (passedImages != '') {
                    initializeUserImages(JSON.parse(passedImages));
                }
                $('#routine-builder').shapeshift({
                    enableDrag: true,
                    enableCrossDrop: true,
                    selector: '.shapeshift-element',
                    gutterY: 30,
                    gutterX: 30
                });
                addAddEventListener();
            }
            return properties;
        }());

        var galleryExtender = (function () {
            var properties = {};
            var oldParameters = PatternIndexProperties.Gallery.Parameters;
            var newParameters = {
                enableDrag: true,
                dragClone: true,
                cloneClass: "img-copy"
            }

            properties.Initialize = function () {
                $.extend(oldParameters, newParameters);
                PatternIndexProperties.Gallery.Update(oldParameters);
                PatternIndexProperties.Gallery.DeleteImageAdder();
                PatternIndexProperties.Gallery.DeleteImageDeleter();
                PatternIndexProperties.Gallery.RemovePatternClickListener();
                PatternIndexProperties.Gallery.ChangeHoverCursor();
            }
            return properties;
        }());


        var multiselectExtender = (function () {
            var properties = {};
            var devices = '@Html.Raw(Model != null ? JsonConvert.SerializeObject(Model.DeviceDTOs) : null)';
            function getAssignedDeviceGuids(allDevices) {
                var selectedDeviceGuids = [];
                $.each(allDevices, function (index, deviceData) {
                    selectedDeviceGuids.push(deviceData.Identifier);
                });
                return selectedDeviceGuids;
            }
            properties.Initialize = function () {
                if (devices != "") {
                    var selectedDeviceGuids = getAssignedDeviceGuids(JSON.parse(devices));
                    DeviceMultiselectProperties.SelectDevices(selectedDeviceGuids);
                }
            }
            properties.GetSelectedDevices = function () {
                return DeviceMultiselectProperties.GetSelectedDevices();
            }
            return properties;
        }());

        var addRoutine = (function () {
            var properties = {};

            function getPatternIdList() {
                var patternIdArrayList = [];
                $('#routineBuilder').children().each(function () {
                    var currentElement = $(this);
                    if (currentElement.attr("id").match("^image-holder_")) {
                        patternIdArrayList.push(currentElement.attr("id").split("_")[1]);
                    }
                });
                return patternIdArrayList;
            }

            function onAjaxSuccess(data) {
                window.location.href = data;
            }

            function makeAddPatternAjaxCall(patternIdList, deviceGuidList) {
                $.ajax({
                    url: '@Url.Action("Add", "Routine", new {area = "Configuration"})',
                    data: {
                        routineId: '@Html.Raw(Model != null ? Model.RoutineId : 0)',
                        patternIdList: patternIdList,
                        deviceGuidList: deviceGuidList
                    },
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    success: onAjaxSuccess
                });
            }

            properties.AddClickListener = function () {
                $('#addRoutine').click(function () {
                    var patternIdList = getPatternIdList();
                    var deviceGuidList = multiselectExtender.GetSelectedDevices();
                    makeAddPatternAjaxCall(patternIdList, deviceGuidList);
                });
            }
            return properties;
        }());


        RoutineAddProperties.SetupPage = function () {
            routineBuilder.Initialize();
            galleryExtender.Initialize();
            addRoutine.AddClickListener();
            //multiselectExtender.Initialize();
        }
    }());
    $(document).ready(function () {
        RoutineAddProperties.SetupPage();
    });
</script>